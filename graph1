import streamlit as st
import pandas as pd
import plotly.express as px
import numpy as np

# --- 1. ê°€ìƒì˜ ë°ì´í„° ìƒì„± (ì‹¤ì œ íŒŒì¼ì„ ëŒ€ì²´í•´ì•¼ í•¨) ---
# ì‚¬ìš©ìê°€ ì²¨ë¶€í•  'ì„¸ê³„ ì¸êµ¬ ë°ì´í„° íŒŒì¼'ì´ ì—†ìœ¼ë¯€ë¡œ,
# ì„ì‹œë¡œ 'world_population.csv'ì™€ ìœ ì‚¬í•œ ê°€ìƒ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
@st.cache_data
def load_and_prepare_data():
    # ì‹¤ì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•ŒëŠ” ì´ ë¶€ë¶„ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
    # df = pd.read_csv("world_population.csv")
    
    countries = ["ëŒ€í•œë¯¼êµ­", "ë¯¸êµ­", "ì¤‘êµ­", "ì¼ë³¸", "ì¸ë„", "ëŸ¬ì‹œì•„", "ë¸Œë¼ì§ˆ", "ë…ì¼", "í”„ë‘ìŠ¤", "ì˜êµ­"]
    country_codes = ["KOR", "USA", "CHN", "IND", "RUS", "BRA", "DEU", "FRA", "GBR"]
    
    # 1970ë…„ë¶€í„° 2022ë…„ê¹Œì§€ì˜ ë°ì´í„° ìƒì„± (ì˜ˆì‹œ)
    data = {'Country Name': countries, 'Country Code': country_codes}
    
    years = [1970, 1980, 1990, 2000, 2010, 2015, 2020, 2022]
    
    for year in years:
        # ì¸êµ¬ìˆ˜: 5ì²œë§Œ ~ 15ì–µ ì‚¬ì´ì˜ ì„ì˜ì˜ ê°’ (ì‹¤ì œ ë°ì´í„° í˜•íƒœë¥¼ í‰ë‚´)
        np.random.seed(year) # ì—°ë„ë³„ ì¼ê´€ì„± ìœ ì§€ë¥¼ ìœ„í•´ ì‹œë“œ ì„¤ì •
        data[str(year)] = np.random.randint(50_000_000, 1_500_000_000, size=len(countries))

    df = pd.DataFrame(data)
    
    # ë°ì´í„°ë¥¼ ê¸´ í˜•ì‹(long format)ìœ¼ë¡œ ë³€í™˜ (Plotly Expressì˜ ì§€ë„ ì‹œê°í™”ë¥¼ ìœ„í•´ í•„ìš”)
    df_long = pd.melt(df, 
                      id_vars=['Country Name', 'Country Code'], 
                      value_vars=[str(y) for y in years],
                      var_name='Year',
                      value_name='Population')
    df_long['Year'] = df_long['Year'].astype(int) # ì—°ë„ë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜
    
    return df_long

# --- 2. í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="í†µí•© ë¶„ì„ ì›¹ì•±",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- 3. ì‚¬ì´ë“œë°” ë©”ë‰´ ---
st.sidebar.title("ğŸ› ï¸ ê¸°ëŠ¥ ë©”ë‰´")
activity = st.sidebar.selectbox(
    "ì›í•˜ëŠ” í™œë™ì„ ì„ íƒí•˜ì„¸ìš”:",
    ["ê³„ì‚°ê¸° ê¸°ëŠ¥", "í™•ë¥  ì‹œë®¬ë ˆì´í„°", "ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„ì„"]
)
st.sidebar.markdown("---")

# --- 4. ë©”ì¸ ì½˜í…ì¸  ---
st.title("í†µí•© ê³„ì‚° ë° ë¶„ì„ ì›¹ì•±")
st.markdown("---")


# =======================================================
# ğŸ“Œ ê¸°ì¡´ ê¸°ëŠ¥ (ê³„ì‚°ê¸° ë° ì‹œë®¬ë ˆì´í„°) - ìš”ì²­ì— ë”°ë¼ ìœ ì§€
# =======================================================
if activity == "ê³„ì‚°ê¸° ê¸°ëŠ¥":
    st.header("ğŸ”¢ ê³ ê¸‰ ê³„ì‚°ê¸°")
    st.info("ì—¬ê¸°ì— ì´ì „ ìš”ì²­ì—ì„œ ë§Œë“  ì‚¬ì¹™ì—°ì‚°, ëª¨ë“ˆëŸ¬, ì§€ìˆ˜, ë¡œê·¸ ì—°ì‚° ê¸°ëŠ¥ ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.")
    # ì˜ˆ: calculator_app.pyì˜ calculate í•¨ìˆ˜ ë“±ì„ ì—¬ê¸°ì— í†µí•©
    
elif activity == "í™•ë¥  ì‹œë®¬ë ˆì´í„°":
    st.header("ğŸ² í™•ë¥  ì‹œë®¬ë ˆì´í„°")
    st.info("ì—¬ê¸°ì— í™•ë¥  ì‹œë®¬ë ˆì´í„° ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.")
    # ì˜ˆ: ì£¼ì‚¬ìœ„ ë˜ì§€ê¸°, ë™ì „ ë˜ì§€ê¸° ì‹œë®¬ë ˆì´ì…˜ ì½”ë“œ ë“±ì„ ì—¬ê¸°ì— í†µí•©

# =======================================================
# ğŸ“Œ ì‹ ê·œ ê¸°ëŠ¥: ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„ì„
# =======================================================
elif activity == "ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„ì„":
    st.header("ğŸŒ ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„ì„")
    st.write("ì²¨ë¶€ëœ íŒŒì¼ (world population ë°ì´í„°)ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¸ê³„ ì¸êµ¬ë¥¼ ì§€ë„ì— ì‹œê°í™”í•©ë‹ˆë‹¤.")

    # ë°ì´í„° ë¡œë“œ
    df_pop = load_and_prepare_data()
    
    if df_pop.empty:
        st.error("ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆê±°ë‚˜ íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. 'world_population.csv' íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    else:
        # ì—°ë„ ì„ íƒ ë“œë¡­ë°•ìŠ¤ (1ë²ˆ ìš”ì²­)
        available_years = sorted(df_pop['Year'].unique())
        selected_year = st.selectbox(
            "ì¸êµ¬ë¥¼ í™•ì¸í•  ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:",
            options=available_years,
            index=available_years.index(2022) if 2022 in available_years else len(available_years) - 1
        )
        
        # ì„ íƒëœ ì—°ë„ì˜ ë°ì´í„° í•„í„°ë§
        df_filtered = df_pop[df_pop['Year'] == selected_year]

        # ì¸êµ¬ìˆ˜ êµ¬ê°„ë³„ ìƒ‰ ì„¤ì • (2ë²ˆ ìš”ì²­)
        # ì¸êµ¬ ë°ì´í„°ì˜ ë¡œê·¸ ë³€í™˜ì„ í†µí•´ ìƒ‰ìƒ êµ¬ë¶„ì„ ë” ëª…í™•í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # Plotly ExpressëŠ” ìë™ìœ¼ë¡œ ì ì ˆí•œ ìƒ‰ìƒ êµ¬ê°„ì„ ì„¤ì •í•´ì¤ë‹ˆë‹¤.
        
        # ë§µ ê·¸ë¦¬ê¸° (1ë²ˆ, 2ë²ˆ ìš”ì²­)
        fig = px.choropleth(df_filtered, 
                            locations="Country Code",
                            color="Population", 
                            hover_name="Country Name",
                            color_continuous_scale=px.colors.sequential.Plasma, # ì ì ˆí•œ ìƒ‰ìƒ ìŠ¤ì¼€ì¼
                            # color_continuous_scale="Viridis", # ë‹¤ë¥¸ ì˜µì…˜
                            title=f"**{selected_year}ë…„ ì„¸ê³„ ì¸êµ¬ ë¶„í¬**",
                            projection="natural earth" # ì§€ë„ íˆ¬ì˜ ë°©ì‹ ì„¤ì •
                           )
        
        # ì¸êµ¬ìˆ˜ ë ˆì´ë¸” í˜•ì‹ ì§€ì •
        fig.update_layout(
            coloraxis_colorbar=dict(
                title="ì¸êµ¬ìˆ˜",
                tickformat='.2s', # ì–µ ë‹¨ìœ„ ë“±ìœ¼ë¡œ í‘œì‹œ
                x=0.01 # ì»¬ëŸ¬ë°” ìœ„ì¹˜ ì¡°ì •
            )
        )
        
        st.plotly_chart(fig, use_container_width=True)

        st.markdown("---")
        st.subheader(f"{selected_year}ë…„ ì£¼ìš” êµ­ê°€ ì¸êµ¬ ë°ì´í„°")
        # ì¸êµ¬ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ 10ê°œ êµ­ê°€ë§Œ í‘œì‹œ (ê°€ë…ì„± í–¥ìƒ)
        st.dataframe(df_filtered.sort_values(by='Population', ascending=False).head(10).reset_index(drop=True))
